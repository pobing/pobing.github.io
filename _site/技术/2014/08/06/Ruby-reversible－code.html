<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>ruby 生成可逆验证码</title>
        <meta name="viewport" content="width=device-width">

        <!-- syntax highlighting CSS -->
        <link rel="stylesheet" href="/css/syntax.css">

        <!-- Custom CSS -->
        <link rel="stylesheet" href="/css/main.css">
        <link rel="stylesheet" href="/css/layout.css">

        <!-- google cse -->
        <script type="text/javascript" src="/javascript/google.cse.js"></script>

    </head>
    <body>

        <div class="site">

          <div class="header">
            <h1 class="title"><a href="/">Pobing's Blog</a></h1>
            <a class="extra" href="/">首页</a>
            <a class="extra" href="/page/read.html">阅读</a>
            <a class="extra" href="/feed.xml">Rss</a>

           <gcse:search></gcse:search>


          </div>

          <h2>ruby 生成可逆验证码</h2>
<p class="meta">06 Aug 2014
<!--   |
 -->
</p>

<div class="post">
<p>项目中要用到邀请码，生成规则是 6为 随机字符（小写字母＋数字），但数据表中不想存这个字段，想根据用户ID 根据不同的算法生成，并且可以加解密。ruby 中可逆的加密算法很少，最后找资料在 stackoverflow 找到了下面的这个<a href="http://stackoverflow.com/questions/1993147/compressing-a-hex-string-in-ruby-rails">帖子</a>：</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="n">b36</span> <span class="o">=</span> <span class="s1">&#39;4b3fc1400de0690bf2000001&#39;</span><span class="o">.</span><span class="n">hex</span><span class="o">.</span><span class="n">to_s</span><span class="p">(</span><span class="mi">36</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="s2">&quot;29a6dblglcujcoeboqp&quot;</span>
<span class="s1">&#39;%024x&#39;</span> <span class="o">%</span> <span class="n">b36</span><span class="o">.</span><span class="n">to_i</span><span class="p">(</span><span class="mi">36</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="s2">&quot;4b3fc1400de0690bf2000001&quot;</span>
</code></pre></div>
<p>于是参考写了下面的方法，根据用户的id，加salt （1000<em>000</em>0）生成 invite_code</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="c1"># 加密</span>
<span class="k">def</span> <span class="nf">encrypt</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
  <span class="n">salt</span> <span class="o">=</span> <span class="mi">1000_000_0</span>
  <span class="n">encryptd_text</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">to_i</span> <span class="o">+</span> <span class="n">salt</span><span class="p">)</span><span class="o">.</span><span class="n">to_s</span>
  <span class="n">encryptd_text</span><span class="o">.</span><span class="n">hex</span><span class="o">.</span><span class="n">to_s</span><span class="p">(</span><span class="mi">36</span><span class="p">)</span>
<span class="k">end</span>

<span class="c1"># 解密</span>
<span class="k">def</span> <span class="nf">decrypt</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
  <span class="n">salt</span> <span class="o">=</span> <span class="mi">1000_000_0</span>
  <span class="n">decryptd_text</span> <span class="o">=</span> <span class="s1">&#39;%024x&#39;</span> <span class="o">%</span> <span class="n">value</span><span class="o">.</span><span class="n">to_i</span><span class="p">(</span><span class="mi">36</span><span class="p">)</span>
  <span class="n">decryptd_text</span><span class="o">.</span><span class="n">to_i</span> <span class="o">-</span> <span class="n">salt</span>
<span class="k">end</span>

<span class="c1">#加密调用:</span>
<span class="n">user_id</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">invite_code</span> <span class="o">=</span> <span class="n">encrypt</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="s2">&quot;4fti4h&quot;</span>
<span class="c1">#解密调用:</span>
<span class="n">user_id</span> <span class="o">=</span> <span class="n">decrypt</span><span class="p">(</span><span class="n">invite_code</span><span class="p">)</span>
 <span class="o">=&gt;</span> <span class="s2">&quot;1&quot;</span>
</code></pre></div>
<p>参考: <a href="http://stackoverflow.com/questions/1993147/compressing-a-hex-string-in-ruby-rails">http://stackoverflow.com/questions/1993147/compressing-a-hex-string-in-ruby-rails</a></p>

</div>
<p>
<a class="bshareDiv" href="http://www.bshare.cn/share">分享按钮</a><script type="text/javascript" charset="utf-8" src="http://static.bshare.cn/b/buttonLite.js#uuid=0bd5d0c2-23dc-45e3-9d1d-1ebffb059419&style=2&textcolor=#000000&bgcolor=none&bp=qqmb,sinaminiblog,qzone,weixin,facebook,twitter&text=分享"></script>
</p>
<!-- disqus comments -->
<!-- <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  var disqus_shortname = 'pobingsblog'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
  (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a> -->
<!-- disques comments end -->
<!-- Duoshuo Comment BEGIN -->
	<div class="ds-thread"></div>
<script type="text/javascript">
var duoshuoQuery = {short_name:"pobing"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = 'http://static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0]
		|| document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
<!-- Duoshuo Comment END -->


          <div class="footer">
              <p>
                <a href="https://github.com/pobing">Git hub</a>
                <a href="https://github.com/pobing">Twitter</a>
                <a href="mailto:cn.jdong@gmail.com">Contact</a>
              </p>
          </div>
        </div>
        <script>
          (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

          ga('create', 'UA-47369732-1', 'pobing.info');
          ga('send', 'pageview');

        </script>
    </body>
</html>
