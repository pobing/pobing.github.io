<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Redis 在短信验证码中的运用</title>
        <meta name="viewport" content="width=device-width">

        <!-- syntax highlighting CSS -->
        <link rel="stylesheet" href="/css/syntax.css">

        <!-- Custom CSS -->
        <link rel="stylesheet" href="/css/main.css">
        <link rel="stylesheet" href="/css/layout.css">

        <!-- google cse -->
        <script type="text/javascript" src="/javascript/google.cse.js"></script>

    </head>
    <body>

        <div class="site">

          <div class="header">
            <h1 class="title"><a href="/">Pobing's Blog</a></h1>
            <a class="extra" href="/">首页</a>
            <a class="extra" href="/page/read.html">阅读</a>
            <a class="extra" href="/feed.xml">Rss</a>

           <gcse:search></gcse:search>


          </div>

          <h2>Redis 在短信验证码中的运用</h2>
<p class="meta">20 Apr 2014
<!--   |
 -->
</p>

<div class="post">
<p>很多时候都想不到用 <a href="http://redis.io">redis</a>，这次项目中要做给用户发送手机验证码的功能。
一般发送手机验证码也就是以下步骤：</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">1.用户获取手机验证码
2.服务器生成验证码（一般是 4-6 位数字），调用第三方发短信接口
3.用户收到验证码的短信后，输入验证码提交
4.服务器验证验证码合法性
</code></pre></div>
<p>下面详细说说以上步骤注意事项：</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">步骤1：发短信是调用第三方接口，是要花钱的。用户请求一次发短信接口，1 毛钱就出去了。所以不能让用户一直请求，要对步骤 1 进行请求限制。限制条件假如是： 1次/分钟, 3次/小时
步骤2：服务器生成的验证码要和当前用户关联
步骤3：因为发短信会有时间的延迟，用户好久收不到短信怎么办，多长时间可以重新请求发短信
步骤4：验证码多长时间有效，假如10分钟内有效
</code></pre></div>
<p>先说传统的解决办法，假如数据库是 Mysql 要实现上述的需求可以实现，因为要对用户的请求次数进行计数，还要判断验证码的有效期，难点就在此，想想就麻烦。
而且验证码是临时性的，其实不需要存储的。所以这时候就是 redis 发挥特长的时候了。</p>

<p>redis 的 setex() 可以设置key 的过期时间，这样就不用判断有效期了。接下来简单说说以上4点的实现,基于ruby 语言：</p>

<p>1.具体的发短信核心代码</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">#加入用户 id=1 的用户请求发端信息接口
  # 获取用户1分钟内请求发短信的次数
  min_hz = redis.get(&quot;1_code_min&quot;)
  # 获取用户 1 小时内请求发短信的次数
  hour_hz = redis.get_hour(&quot;1_code_hour&quot;)
  # 说明1分钟重复请求
  raise &quot;rate_limit_error&quot; if min_hz == 1
  #说明超过1小时请求的次数
  raise &quot;rate_limit_error&quot; if hour_hz &gt;= 3
  #生成6位验证码
  sms_code=(&#39;0&#39;..&#39;9&#39;).to_a.sample(6).join
  #redis 存入用户生成的code，key 为 1_sms_code, 10分钟后过期
  redis.setex(&quot;1_sms_code&quot;,60*10,sms_code)
  # 1小时内第一次设置 key 1_code_min
  redis.setex(&quot;1_code_hour&quot;, 60*60, 1) if min_hz == 0
  #或者对1小时的次数加1
  redis.incr(&quot;1_code_hour&quot;)
  redis.setex(&quot;1_code_hour&quot;, 60*60, 1) if hour_hz == 0 &amp;&amp; hour_hz &lt; 3
  #掉第三方服务发送验证码
  res = send(phone,code)
</code></pre></div>
<p>2.整合推立方的发短信服务</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">require &#39;net/http&#39;
#http://tui3.com/Members/doc/page/smssend/
  apikey = &quot;tui3.apikey&quot;
  format = &quot;tui3.format&quot;
  productid = &quot;tui3.productid&quot;
  address = &quot;tui3.address&quot;
  content = &quot;验证码是:#{code}。您验证您的手机号码，请勿向任何人提供您收到的验证码。&quot;
  path = &quot;/api/send/?k=#{apikey}&amp;r=#{format}&amp;p=#{productid}&amp;t=#{phone_num}&amp;c=#{content}&quot;
  response = Net::HTTP.get(address,path)
  res = JSON.parse(response)
  res
</code></pre></div>
<p>总结：程序开发中，如果是临时的数据，如验证码，激活码什么的，就没必要存入数据库，可以考虑使用缓存机制 redis，memcached，都是不错的选择！</p>

</div>
<p>
<a class="bshareDiv" href="http://www.bshare.cn/share">分享按钮</a><script type="text/javascript" charset="utf-8" src="http://static.bshare.cn/b/buttonLite.js#uuid=0bd5d0c2-23dc-45e3-9d1d-1ebffb059419&style=2&textcolor=#000000&bgcolor=none&bp=qqmb,sinaminiblog,qzone,weixin,facebook,twitter&text=分享"></script>
</p>
<!-- disqus comments -->
<!-- <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  var disqus_shortname = 'pobingsblog'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
  (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a> -->
<!-- disques comments end -->
<!-- Duoshuo Comment BEGIN -->
	<div class="ds-thread"></div>
<script type="text/javascript">
var duoshuoQuery = {short_name:"pobing"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = 'http://static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0]
		|| document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
<!-- Duoshuo Comment END -->


          <div class="footer">
              <p>
                <a href="https://github.com/pobing">Git hub</a>
                <a href="https://github.com/pobing">Twitter</a>
                <a href="mailto:cn.jdong@gmail.com">Contact</a>
              </p>
          </div>
        </div>
        <script>
          (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

          ga('create', 'UA-47369732-1', 'pobing.info');
          ga('send', 'pageview');

        </script>
    </body>
</html>
